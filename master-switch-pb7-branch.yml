---
# Switch pb7 branch/commit on localhost
# Steps:
# 1. Fetch from origin
# 2. Check for uncommitted changes (fail if found)
# 3. Checkout specified branch
# 4. Optionally checkout specific commit (detached HEAD)
# 5. Pull if on branch HEAD (not detached)
# 6. Restart pbgui services

- hosts: localhost
  gather_facts: "{{ debug }}"

  vars:
    user: "{{ user }}"
    pbgdir: "{{ pbgdir }}"
    pbgvenv: "{{ pbgvenv }}"
    pb7dir: "{{ pb7dir }}"
    pb7venv: "{{ pb7venv }}"
    target_branch: "{{ pb7_branch }}"
    target_commit: "{{ pb7_commit | default('') }}"
    remote_name: "{{ pb7_remote_name | default('origin') }}"
    remote_url: "{{ pb7_remote_url | default('') }}"

  tasks:
    - name: display facts
      debug:
        var: ansible_facts
      tags: debug,never

    - name: Ensure custom remote exists (optional)
      shell: |
        set -e
        if [ -n "{{ remote_url }}" ]; then
          if git remote get-url "{{ remote_name }}" >/dev/null 2>&1; then
            git remote set-url "{{ remote_name }}" "{{ remote_url }}"
          else
            git remote add "{{ remote_name }}" "{{ remote_url }}"
          fi
        fi
      args:
        chdir: "{{ pb7dir }}"
      when: pb7dir != ""
      changed_when: false

    - name: Fetch from selected remote
      command: git fetch "{{ remote_name }}"
      args:
        chdir: "{{ pb7dir }}"
      when: pb7dir != ""
      changed_when: false

    - name: Check for uncommitted changes (tracked files only)
      shell: git diff --name-only && git diff --cached --name-only
      args:
        chdir: "{{ pb7dir }}"
      register: git_status
      changed_when: false

    - name: Fail if uncommitted changes exist
      fail:
        msg: "Uncommitted changes detected in PB7. Please commit or stash changes before switching branches."
      when: git_status.stdout != ""

    - name: Check if branch exists locally
      command: git show-ref --verify --quiet "refs/heads/{{ target_branch }}"
      args:
        chdir: "{{ pb7dir }}"
      register: branch_exists
      failed_when: false
      changed_when: false

    - name: Create and checkout local branch from remote if it doesn't exist
      command: git checkout -b "{{ target_branch }}" --track "{{ remote_name }}/{{ target_branch }}"
      args:
        chdir: "{{ pb7dir }}"
      when: branch_exists.rc != 0
      notify: restart pb7

    - name: Checkout target branch (if already exists locally)
      command: git checkout "{{ target_branch }}"
      args:
        chdir: "{{ pb7dir }}"
      when: branch_exists.rc == 0
      notify: restart pb7

    - name: Reset to specific commit if provided (stays on branch)
      command: git reset --hard "{{ target_commit }}"
      args:
        chdir: "{{ pb7dir }}"
      when: target_commit != ""
      register: commit_reset
      notify: restart pb7

    - name: Pull latest changes (only if no specific commit provided)
      command: git pull "{{ remote_name }}" "{{ target_branch }}"
      args:
        chdir: "{{ pb7dir }}"
      when: target_commit == ""
      register: pull_result
      notify: restart pb7

    - name: Display checkout result
      debug:
        msg: |
          PB7 Branch: {{ target_branch }}
          PB7 Commit: {{ target_commit if target_commit != '' else 'HEAD' }}
          Status: Switched successfully
      tags: debug,never

  handlers:
    - name: Install pb7 requirements
      pip:
        requirements: "{{ pb7dir }}/requirements.txt"
        virtualenv: "{{ pb7venv }}"
        extra_args: --upgrade pip
      listen: "restart pb7"

    - name: Build passivbot-rust with maturin
      shell: |
        source ~/.profile || source ~/.bashrc || true
        source "{{ pb7venv }}/bin/activate"
        maturin develop --release
      args:
        chdir: "{{ pb7dir }}/passivbot-rust"
        executable: /bin/bash
      register: maturin_result
      listen: "restart pb7"

    - name: kill all pb7 processes
      shell: |
        pids="$(ps -ef | grep "{{ pb7dir }}/src/main.py" | grep -v grep | awk '{print $2}')"
        if [ -n "$pids" ]; then
          kill $pids
        fi
      args:
        executable: /bin/bash
      changed_when: false
      listen: "restart pb7"
      ignore_errors: yes

    - name: Make sure PBRun ist running
      shell: |
        python "{{ pbgdir }}/starter.py" -s PBRun
      args:
        executable: /bin/bash
        chdir: "{{ pbgdir }}"
      listen: "restart pb7"
